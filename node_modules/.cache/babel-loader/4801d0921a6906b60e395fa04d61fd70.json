{"ast":null,"code":"import _regeneratorRuntime from\"F:/My Project/Leo/Nivid/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _toConsumableArray from\"F:/My Project/Leo/Nivid/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _asyncToGenerator from\"F:/My Project/Leo/Nivid/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"F:/My Project/Leo/Nivid/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import{Fragment as _Fragment}from\"react/jsx-runtime\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{useState,useEffect}from'react';import{useLocation}from\"react-router-dom\";import{useAuth}from\"../context/userContext\";// context\nimport{CSSTransition}from'react-transition-group';import{useHistory}from\"react-router-dom\";import{ButtonSmall}from'../components/utilities/Buttons';import Loader from'../components/Loader';import{FaStar}from'react-icons/fa';var GiveReview=function GiveReview(){var search=useLocation().search;var eventId=new URLSearchParams(search).get('id');var history=useHistory();var _useState=useState([]),_useState2=_slicedToArray(_useState,2),sellers=_useState2[0],setSellers=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),isMounted=_useState4[0],setIsMounted=_useState4[1];var _useState5=useState(\"\"),_useState6=_slicedToArray(_useState5,2),error=_useState6[0],setError=_useState6[1];var _useAuth=useAuth(),user=_useAuth.user,getSalesOfEventIdFromDB=_useAuth.getSalesOfEventIdFromDB,getSellersInDbWithUids=_useAuth.getSellersInDbWithUids,getEventFromUid=_useAuth.getEventFromUid,getReviewsOfSellerUid=_useAuth.getReviewsOfSellerUid,addReviewOfSellerUid=_useAuth.addReviewOfSellerUid,sendInBlue_sendNotificationToSellerOfReview=_useAuth.sendInBlue_sendNotificationToSellerOfReview;// context\nuseEffect(function(){if(eventId===null||eventId===undefined||eventId.length<1){return history.push('/');}// Si pas connecté\nif(!user){setIsMounted(true);return setError(\"Vous devez être connecté pour laisser un avis.\");}// Si pas le createur de l'event\ngetEventFromUid(eventId).then(function(res){if(!res||user.uid!==res.user){return history.push('/');}});if(eventId!==null&&eventId.length>1){getAllowedSellers().then(function(newSellers){if(newSellers===false)return history.push(\"/\");// On ne prend que les sellers qui n'ont pas deja un avis avec l'id de l'event\nvar filtered=newSellers.filter(function(seller){return seller.reviews.filter(function(review){return review.eventID===eventId;}).length===0;});var final=filtered.map(function(item){return{newReview:{},companyName:item.companyName,reviews:item.reviews,uid:item.uid,firstName:item.firstName,email:item.email};});setSellers(final);setError(\"\");setIsMounted(true);});}},[]);function getAllowedSellers(){return _getAllowedSellers.apply(this,arguments);}function _getAllowedSellers(){_getAllowedSellers=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var res,sellerIds,sellersArray,newSellers;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return getSalesOfEventIdFromDB(eventId);case 2:res=_context2.sent;if(!(res.length<1)){_context2.next=5;break;}return _context2.abrupt(\"return\",false);case 5:sellerIds=res.map(function(element){return element.sellerID;});_context2.next=8;return getSellersInDbWithUids(sellerIds);case 8:sellersArray=_context2.sent;newSellers=new Promise(function(resolve,reject){sellersArray.map(/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(seller){var res;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return getReviewsOfSellerUid(seller.uid);case 2:res=_context.sent;seller.reviews=res;resolve(seller);case 5:case\"end\":return _context.stop();}}},_callee);}));return function(_x3){return _ref.apply(this,arguments);};}());});return _context2.abrupt(\"return\",Promise.all([newSellers]).then(function(val){return val;}));case 11:case\"end\":return _context2.stop();}}},_callee2);}));return _getAllowedSellers.apply(this,arguments);}function handleNoteChanged(key,note){var newSellers=_toConsumableArray(sellers);newSellers[key].newReview.note=note;setSellers(newSellers);}function handleCommentChanged(key,comment){var newSellers=_toConsumableArray(sellers);newSellers[key].newReview.comment=comment;setSellers(newSellers);}function handleSendReview(_x,_x2){return _handleSendReview.apply(this,arguments);}function _handleSendReview(){_handleSendReview=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(sellerUID,key){var note,comment,res,newSellers,newReview;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:note=sellers[key].newReview.note;comment=sellers[key].newReview.comment;if(!(note===undefined||comment===undefined)){_context3.next=4;break;}return _context3.abrupt(\"return\");case 4:_context3.next=6;return addReviewOfSellerUid(sellerUID,eventId,note,comment,user.displayName);case 6:res=_context3.sent;if(res){newSellers=_toConsumableArray(sellers);newReview={eventID:eventId,note:note,comment:comment};newSellers[key].reviews.push(newReview);newSellers[key].newReview=newReview;setSellers(newSellers);sendInBlue_sendNotificationToSellerOfReview(newSellers[key].email,newSellers[key].firstName);}case 8:case\"end\":return _context3.stop();}}},_callee3);}));return _handleSendReview.apply(this,arguments);}return/*#__PURE__*/_jsxs(\"div\",{className:\"GiveReview_container\",children:[/*#__PURE__*/_jsx(CSSTransition,{in:!isMounted,timeout:300,classNames:\"pageTransition\",unmountOnExit:true,children:/*#__PURE__*/_jsx(Loader,{})}),/*#__PURE__*/_jsx(CSSTransition,{in:isMounted,timeout:300,classNames:\"pageTransition\",unmountOnExit:true,children:/*#__PURE__*/_jsx(\"div\",{className:\"GiveReview\",children:error.length<1?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"h1\",{children:\"Donnez une note aux prestataires que vous aviez choisi\"}),sellers.map(function(seller,key){return seller.newReview.eventID===undefined?/*#__PURE__*/_jsxs(\"div\",{className:\"GiveReview__item\",children:[/*#__PURE__*/_jsx(\"h2\",{children:seller.companyName}),/*#__PURE__*/_jsxs(\"div\",{className:\"stars_container\",children:[/*#__PURE__*/_jsx(FaStar,{className:\"\".concat(seller.newReview.note>4?\"active\":\"\"),onClick:function onClick(){return handleNoteChanged(key,5);}}),/*#__PURE__*/_jsx(FaStar,{className:\"\".concat(seller.newReview.note>3?\"active\":\"\"),onClick:function onClick(){return handleNoteChanged(key,4);}}),/*#__PURE__*/_jsx(FaStar,{className:\"\".concat(seller.newReview.note>2?\"active\":\"\"),onClick:function onClick(){return handleNoteChanged(key,3);}}),/*#__PURE__*/_jsx(FaStar,{className:\"\".concat(seller.newReview.note>1?\"active\":\"\"),onClick:function onClick(){return handleNoteChanged(key,2);}}),/*#__PURE__*/_jsx(FaStar,{className:\"\".concat(seller.newReview.note>0?\"active\":\"\"),onClick:function onClick(){return handleNoteChanged(key,1);}})]}),/*#__PURE__*/_jsx(\"div\",{className:\"formField\",children:/*#__PURE__*/_jsx(\"textarea\",{type:\"text\",value:seller.comment,onChange:function onChange(e){return handleCommentChanged(key,e.target.value);},placeholder:\"Laissez un commentaire\"})}),/*#__PURE__*/_jsx(\"div\",{className:\"buttonSendForm\",children:/*#__PURE__*/_jsx(ButtonSmall,{onClick:function onClick(){return handleSendReview(seller.uid,key);},color:\"blue\",value:\"Valider\",disabled:seller.newReview.note===undefined||seller.newReview.comment===undefined||seller.newReview.comment.length<3})})]},key):/*#__PURE__*/_jsx(\"div\",{children:\"Merci\"},key);})]}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"p\",{children:error}),/*#__PURE__*/_jsx(\"span\",{className:\"linkRedirect\",onClick:function onClick(){return history.push('/compte');},children:\"Se connecter\"})]})})})]});};export default GiveReview;","map":{"version":3,"sources":["F:/My Project/Leo/Nivid/src/pages/GiveReview.js"],"names":["useState","useEffect","useLocation","useAuth","CSSTransition","useHistory","ButtonSmall","Loader","FaStar","GiveReview","search","eventId","URLSearchParams","get","history","sellers","setSellers","isMounted","setIsMounted","error","setError","user","getSalesOfEventIdFromDB","getSellersInDbWithUids","getEventFromUid","getReviewsOfSellerUid","addReviewOfSellerUid","sendInBlue_sendNotificationToSellerOfReview","undefined","length","push","then","res","uid","getAllowedSellers","newSellers","filtered","filter","seller","reviews","review","eventID","final","map","item","newReview","companyName","firstName","email","sellerIds","element","sellerID","sellersArray","Promise","resolve","reject","all","val","handleNoteChanged","key","note","handleCommentChanged","comment","handleSendReview","sellerUID","displayName","e","target","value"],"mappings":"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","sourcesContent":["import { useState, useEffect } from 'react'\r\nimport { useLocation } from \"react-router-dom\";\r\nimport { useAuth } from \"../context/userContext\"; // context\r\nimport { CSSTransition } from 'react-transition-group'\r\nimport { useHistory } from \"react-router-dom\";\r\nimport { ButtonSmall } from '../components/utilities/Buttons';\r\n\r\nimport Loader from '../components/Loader'\r\n\r\nimport { FaStar } from 'react-icons/fa';\r\n\r\nconst GiveReview = () => {\r\n\r\n    const search = useLocation().search\r\n    const eventId = new URLSearchParams(search).get('id')\r\n\r\n    const history = useHistory()\r\n\r\n    const [sellers, setSellers] = useState([])\r\n    const [isMounted, setIsMounted] = useState(false)\r\n    const [error, setError] = useState(\"\")\r\n\r\n    const {\r\n        user,\r\n        getSalesOfEventIdFromDB,\r\n        getSellersInDbWithUids,\r\n        getEventFromUid,\r\n        getReviewsOfSellerUid,\r\n        addReviewOfSellerUid,\r\n        sendInBlue_sendNotificationToSellerOfReview } = useAuth() // context\r\n\r\n\r\n    useEffect(() => {\r\n        if (eventId === null || eventId === undefined || eventId.length < 1) {\r\n            return history.push('/')\r\n        }\r\n        // Si pas connecté\r\n        if (!user) {\r\n            setIsMounted(true)\r\n            return setError(\"Vous devez être connecté pour laisser un avis.\")\r\n        }\r\n        // Si pas le createur de l'event\r\n        getEventFromUid(eventId).then(res => {\r\n            if (!res || user.uid !== res.user) {\r\n                return history.push('/')\r\n            }\r\n        })\r\n\r\n\r\n        if (eventId !== null && eventId.length > 1) {\r\n            getAllowedSellers().then(newSellers => {\r\n                if (newSellers === false) return history.push(\"/\")\r\n                // On ne prend que les sellers qui n'ont pas deja un avis avec l'id de l'event\r\n                const filtered = newSellers.filter(seller => seller.reviews.filter(review => review.eventID === eventId).length === 0)\r\n                const final = filtered.map(item => {\r\n                    return {\r\n                        newReview: {},\r\n                        companyName: item.companyName,\r\n                        reviews: item.reviews,\r\n                        uid: item.uid,\r\n                        firstName: item.firstName,\r\n                        email: item.email\r\n                    }\r\n                })\r\n                setSellers(final)\r\n                setError(\"\")\r\n                setIsMounted(true)\r\n            })\r\n        }\r\n    }, [])\r\n\r\n    async function getAllowedSellers() {\r\n        const res = await getSalesOfEventIdFromDB(eventId)\r\n        if (res.length < 1) return false\r\n        const sellerIds = res.map(element => element.sellerID)\r\n\r\n        const sellersArray = await getSellersInDbWithUids(sellerIds)\r\n        const newSellers = new Promise((resolve, reject) => {\r\n            sellersArray.map(async seller => {\r\n                const res = await getReviewsOfSellerUid(seller.uid)\r\n                seller.reviews = res\r\n                resolve(seller)\r\n            })\r\n        });\r\n        return Promise.all([newSellers]).then((val) => val)\r\n    }\r\n\r\n    function handleNoteChanged(key, note) {\r\n        let newSellers = [...sellers]\r\n        newSellers[key].newReview.note = note\r\n        setSellers(newSellers)\r\n    }\r\n\r\n    function handleCommentChanged(key, comment) {\r\n        let newSellers = [...sellers]\r\n        newSellers[key].newReview.comment = comment\r\n        setSellers(newSellers)\r\n    }\r\n\r\n    async function handleSendReview(sellerUID, key) {\r\n        const note = sellers[key].newReview.note\r\n        const comment = sellers[key].newReview.comment\r\n        if (note === undefined || comment === undefined) return\r\n        const res = await addReviewOfSellerUid(sellerUID, eventId, note, comment, user.displayName)\r\n        if (res) {\r\n            let newSellers = [...sellers]\r\n            const newReview = { eventID: eventId, note: note, comment: comment }\r\n            newSellers[key].reviews.push(newReview)\r\n            newSellers[key].newReview = newReview\r\n            setSellers(newSellers)\r\n\r\n            sendInBlue_sendNotificationToSellerOfReview(newSellers[key].email, newSellers[key].firstName)\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div className=\"GiveReview_container\">\r\n            <CSSTransition\r\n                in={!isMounted}\r\n                timeout={300}\r\n                classNames=\"pageTransition\"\r\n                unmountOnExit\r\n            >\r\n                <Loader />\r\n            </CSSTransition>\r\n\r\n            <CSSTransition\r\n                in={isMounted}\r\n                timeout={300}\r\n                classNames=\"pageTransition\"\r\n                unmountOnExit\r\n            >\r\n                <div className=\"GiveReview\">\r\n                    {error.length < 1 ?\r\n                        <>\r\n                            <h1>Donnez une note aux prestataires que vous aviez choisi</h1>\r\n                            {sellers.map((seller, key) =>\r\n                                seller.newReview.eventID === undefined ?\r\n                                    <div key={key} className=\"GiveReview__item\" >\r\n                                        <h2>{seller.companyName}</h2>\r\n                                        <div className=\"stars_container\">\r\n                                            <FaStar className={`${seller.newReview.note > 4 ? \"active\" : \"\"}`} onClick={() => handleNoteChanged(key, 5)} />\r\n                                            <FaStar className={`${seller.newReview.note > 3 ? \"active\" : \"\"}`} onClick={() => handleNoteChanged(key, 4)} />\r\n                                            <FaStar className={`${seller.newReview.note > 2 ? \"active\" : \"\"}`} onClick={() => handleNoteChanged(key, 3)} />\r\n                                            <FaStar className={`${seller.newReview.note > 1 ? \"active\" : \"\"}`} onClick={() => handleNoteChanged(key, 2)} />\r\n                                            <FaStar className={`${seller.newReview.note > 0 ? \"active\" : \"\"}`} onClick={() => handleNoteChanged(key, 1)} />\r\n                                        </div>\r\n                                        <div className=\"formField\">\r\n                                            <textarea\r\n                                                type=\"text\"\r\n                                                value={seller.comment}\r\n                                                onChange={e => handleCommentChanged(key, e.target.value)}\r\n                                                placeholder=\"Laissez un commentaire\"\r\n                                            />\r\n                                        </div>\r\n                                        <div className=\"buttonSendForm\">\r\n                                            <ButtonSmall\r\n                                                onClick={() => handleSendReview(seller.uid, key)}\r\n                                                color=\"blue\"\r\n                                                value=\"Valider\"\r\n                                                disabled={seller.newReview.note === undefined || seller.newReview.comment === undefined || seller.newReview.comment.length < 3}\r\n                                            />\r\n                                        </div>\r\n                                    </div>\r\n                                    :\r\n                                    <div key={key}>Merci</div>\r\n                            )}\r\n                        </>\r\n                        :\r\n                        <>\r\n                            <p>{error}</p>\r\n                            <span className=\"linkRedirect\" onClick={() => history.push('/compte')} >Se connecter</span>\r\n                        </>\r\n                    }\r\n                </div>\r\n            </CSSTransition>\r\n        </div >\r\n    )\r\n}\r\n\r\nexport default GiveReview"]},"metadata":{},"sourceType":"module"}